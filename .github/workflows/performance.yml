name: Performance Test

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  performance-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout head branch
        uses: actions/checkout@v4
        with:
          path: head

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.10.0

      - name: Install dependencies for base
        working-directory: base
        run: |
          pnpm install --frozen-lockfile
          pnpm build
          npx playwright install chromium

      - name: Install dependencies for head
        working-directory: head
        run: |
          pnpm install --frozen-lockfile
          pnpm build
          npx playwright install chromium

      - name: Check if performance scripts exist in base
        id: check-base
        working-directory: base
        run: |
          if [[ -f "scripts/measure-performance.js" ]]; then
            echo "has_perf_script=true" >> $GITHUB_OUTPUT
          else
            echo "has_perf_script=false" >> $GITHUB_OUTPUT
          fi

      - name: Run performance test on base branch
        id: base-perf
        if: steps.check-base.outputs.has_perf_script == 'true'
        working-directory: base
        run: |
          pnpm perf --size medium --iterations 3
          # Get the latest result file
          RESULT_FILE=$(ls -t performance-results/perf-medium-*.json | head -1)
          echo "result_file=$RESULT_FILE" >> $GITHUB_OUTPUT

      - name: Run performance test on head branch
        id: head-perf
        working-directory: head
        run: |
          pnpm perf --size medium --iterations 3
          # Get the latest result file
          RESULT_FILE=$(ls -t performance-results/perf-medium-*.json | head -1)
          echo "result_file=$RESULT_FILE" >> $GITHUB_OUTPUT

      - name: Compare performance
        id: compare
        if: steps.check-base.outputs.has_perf_script == 'true'
        working-directory: head
        run: |
          # Copy base result to head directory for comparison
          cp ../base/${{ steps.base-perf.outputs.result_file }} performance-results/base-result.json

          # Run comparison script with JSON output
          COMPARISON_JSON=$(pnpm perf:compare --size medium performance-results/base-result.json ${{ steps.head-perf.outputs.result_file }} --json)

          # Extract values from comparison output
          BASE_TIME=$(echo "$COMPARISON_JSON" | jq -r '.baseline.averageOperationTime')
          HEAD_TIME=$(echo "$COMPARISON_JSON" | jq -r '.current.averageOperationTime')
          CHANGE_PERCENT=$(echo "$COMPARISON_JSON" | jq -r '.changePercent')
          DIFF=$(echo "$COMPARISON_JSON" | jq -r '.difference')

          echo "base_time=$BASE_TIME" >> $GITHUB_OUTPUT
          echo "head_time=$HEAD_TIME" >> $GITHUB_OUTPUT
          echo "change_percent=$CHANGE_PERCENT" >> $GITHUB_OUTPUT
          echo "diff=$DIFF" >> $GITHUB_OUTPUT

          # Determine status based on percentage change
          if (( $(echo "$CHANGE_PERCENT > 10" | bc -l) )); then
            echo "status=degraded" >> $GITHUB_OUTPUT
            echo "emoji=üî¥" >> $GITHUB_OUTPUT
          elif (( $(echo "$CHANGE_PERCENT < -5" | bc -l) )); then
            echo "status=improved" >> $GITHUB_OUTPUT
            echo "emoji=üü¢" >> $GITHUB_OUTPUT
          else
            echo "status=neutral" >> $GITHUB_OUTPUT
            echo "emoji=üü°" >> $GITHUB_OUTPUT
          fi

      - name: Handle missing baseline
        id: compare-fallback
        if: steps.check-base.outputs.has_perf_script == 'false'
        working-directory: head
        run: |
          HEAD_RESULT=$(jq -r '.summary.keyboardNavigation.averageOperationTime' ${{ steps.head-perf.outputs.result_file }})
          echo "base_time=N/A" >> $GITHUB_OUTPUT
          echo "head_time=$HEAD_RESULT" >> $GITHUB_OUTPUT
          echo "change_percent=N/A" >> $GITHUB_OUTPUT
          echo "diff=N/A" >> $GITHUB_OUTPUT
          echo "status=no-baseline" >> $GITHUB_OUTPUT
          echo "emoji=‚ÑπÔ∏è" >> $GITHUB_OUTPUT

      - name: Generate Job Summary
        run: |
          # Use outputs from either compare or compare-fallback
          STATUS="${{ steps.compare.outputs.status || steps.compare-fallback.outputs.status }}"
          EMOJI="${{ steps.compare.outputs.emoji || steps.compare-fallback.outputs.emoji }}"
          BASE_TIME="${{ steps.compare.outputs.base_time || steps.compare-fallback.outputs.base_time }}"
          HEAD_TIME="${{ steps.compare.outputs.head_time || steps.compare-fallback.outputs.head_time }}"
          DIFF="${{ steps.compare.outputs.diff || steps.compare-fallback.outputs.diff }}"
          CHANGE_PERCENT="${{ steps.compare.outputs.change_percent || steps.compare-fallback.outputs.change_percent }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Performance Test Results

          ## $EMOJI Keyboard Navigation Performance

          | Metric | Base Branch | Head Branch | Change |
          |--------|-------------|-------------|--------|
          | Average Operation Time | ${BASE_TIME}ms | ${HEAD_TIME}ms | ${DIFF}ms (${CHANGE_PERCENT}%) |

          ### Test Configuration
          - **Size**: Medium (20 files, 10,000 lines)
          - **Iterations**: 3
          - **Operations**: Line navigation (j/k), chunk navigation (n/p), file navigation ([/])

          EOF

          if [[ "$STATUS" == "degraded" ]]; then
            echo "### ‚ö†Ô∏è Performance Degradation Detected" >> $GITHUB_STEP_SUMMARY
            echo "Performance has degraded by more than 10%. Please investigate before merging." >> $GITHUB_STEP_SUMMARY
          elif [[ "$STATUS" == "improved" ]]; then
            echo "### ‚úÖ Performance Improved" >> $GITHUB_STEP_SUMMARY
            echo "Great job! Performance has improved by more than 5%." >> $GITHUB_STEP_SUMMARY
          elif [[ "$STATUS" == "no-baseline" ]]; then
            echo "### ‚ÑπÔ∏è No Baseline Available" >> $GITHUB_STEP_SUMMARY
            echo "Performance test script not found in base branch. Cannot compare performance." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ÑπÔ∏è Performance Neutral" >> $GITHUB_STEP_SUMMARY
            echo "No significant performance change detected." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Performance Test Results')
            );

            const status = '${{ steps.compare.outputs.status || steps.compare-fallback.outputs.status }}';
            const emoji = '${{ steps.compare.outputs.emoji || steps.compare-fallback.outputs.emoji }}';
            const baseTime = '${{ steps.compare.outputs.base_time || steps.compare-fallback.outputs.base_time }}';
            const headTime = '${{ steps.compare.outputs.head_time || steps.compare-fallback.outputs.head_time }}';
            const changePercent = '${{ steps.compare.outputs.change_percent || steps.compare-fallback.outputs.change_percent }}';
            const diff = '${{ steps.compare.outputs.diff || steps.compare-fallback.outputs.diff }}';

            let statusMessage = '';
            if (status === 'degraded') {
              statusMessage = '### ‚ö†Ô∏è Performance degradation detected!\nPerformance has degraded by more than 10%. Please investigate before merging.';
            } else if (status === 'improved') {
              statusMessage = '### ‚úÖ Performance improved!\nGreat job! Performance has improved by more than 5%.';
            } else if (status === 'no-baseline') {
              statusMessage = '### ‚ÑπÔ∏è No baseline available\nPerformance test script not found in base branch. Showing head branch results only.';
            }

            const body = `## Performance Test Results

            ${emoji} **Keyboard Navigation Performance**

            | Metric | Base Branch | Head Branch | Change |
            |--------|-------------|-------------|--------|
            | Average Operation Time | ${baseTime}ms | ${headTime}ms | ${diff}ms (${changePercent}%) |

            ${statusMessage}

            <details>
            <summary>Test Configuration</summary>

            - **Size**: Medium (20 files, 10,000 lines)
            - **Iterations**: 3
            - **Operations**: Line navigation (j/k), chunk navigation (n/p), file navigation ([/])

            </details>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check performance degradation
        if: steps.compare.outputs.status == 'degraded'
        run: |
          echo "::warning::Performance has degraded by ${{ steps.compare.outputs.change_percent }}%"
          exit 1
