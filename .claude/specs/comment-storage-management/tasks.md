# 実装計画

- [x] 1. ストレージサービスの実装
  - StorageServiceクラスを作成し、localStorageへのアクセスを抽象化
  - 差分コンテキストごとのデータ保存・読み込み機能を実装
  - ストレージキーの生成ロジックを実装（動的参照の正規化を含む）
  - _要件: 1.1, 1.4, 3.1, 3.2_

- [x] 2. データモデルとユーティリティ関数の実装
  - [x] 2.1 DiffComment、ViewedFileRecord、DiffContextStorageの型定義を追加
    - types/diff.tsに新しいインターフェースを定義
    - 既存のCommentインターフェースとの互換性を考慮
    - _要件: 1.4, 4.1, 4.4_

  - [x] 2.2 コミット参照の正規化関数を実装
    - normalizeCommitish関数を作成
    - ブランチ名からコミットハッシュへの解決機能を追加
    - _要件: 3.1_

  - [x] 2.3 差分内容のハッシュ生成関数を実装
    - Web Crypto APIを使用したSHA-256ハッシュ生成
    - フォールバック実装も含める
    - _要件: 2.2_

- [x] 3. コメント管理フックの実装
  - [x] 3.1 新しいuseDiffCommentsフックを作成
    - 差分コンテキストを考慮したコメントの保存・読み込み
    - コメントのCRUD操作（作成、読み取り、更新、削除）
    - プロンプト生成機能の実装
    - _要件: 1.1, 1.2, 1.3_

  - [x] 3.2 既存のuseLocalCommentsフックとの並行運用を実装
    - 新旧両方のデータ形式をサポート
    - 段階的な移行を可能にする
    - _要件: 3.4_

- [x] 4. Viewed状態管理の実装
  - [x] 4.1 useViewedFilesフックを作成
    - 差分コンテキストごとのViewed状態の保存・読み込み
    - ファイルの差分内容のハッシュ計算と保存
    - _要件: 2.1, 2.2_

  - [x] 4.2 差分内容の変更検知機能を実装
    - 保存されたハッシュと現在の差分内容の比較
    - 内容が変更された場合のViewed状態リセット
    - _要件: 2.3, 2.4, 2.5_

- [x] 5. UIコンポーネントの更新
  - [x] 5.1 App.tsxの修正
    - 新しいフックの統合
    - DiffResponseからの情報を適切に渡す
    - _要件: 1.2, 2.1_

  - [x] 5.2 DiffViewerコンポーネントの更新
    - コメント作成時にside情報を含める
    - チャンクヘッダー情報の取得と保存
    - _要件: 1.4, 4.1_

  - [x] 5.3 CommentButtonとInlineCommentの更新
    - 新しいデータ構造に対応
    - side情報の表示と処理
    - _要件: 1.2, 4.2_

- [x] 6. エラーハンドリングとデータ管理
  - [x] 6.1 ストレージ容量の監視機能を実装
    - 使用容量の計算
    - 容量超過時の警告表示
    - _要件: 3.3_

  - [x] 6.2 古いデータのクリーンアップ機能を実装
    - 指定日数以前のデータの削除
    - ユーザー確認付きのクリーンアップ
    - _要件: 3.3_

- [ ] 7. テストの実装
  - [ ] 7.1 ユニットテストの作成
    - StorageServiceのテスト
    - 正規化関数のテスト
    - ハッシュ生成のテスト
    - _要件: 全般_

  - [ ] 7.2 フックの統合テストを作成
    - useDiffCommentsのテスト
    - useViewedFilesのテスト
    - データ永続性の確認
    - _要件: 全般_

  - [ ] 7.3 UIコンポーネントのテスト更新
    - 新しいデータ構造での動作確認
    - エッジケースのテスト
    - _要件: 全般_