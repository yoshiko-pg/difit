# 要件定義書

## 概要

この機能は、WebUIにおけるコメントと既読状態の管理システムを改善し、表示している差分範囲に基づいてデータを適切に分離します。現在、データ構造が特定の差分コンテキスト（ベースコミットと対象コミット）を考慮していないため、異なる差分のコメントが誤った場所に表示される問題があります。この機能強化では、コメントと既読状態を完全な差分コンテキストを認識して保存する、より堅牢なデータ構造を実装します。

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、コメントを特定の差分コンテキストと共に保存したい。これにより、ある差分範囲のコメントが別の差分範囲を表示している時に現れないようにしたい。

#### 受け入れ基準

1. ユーザーが差分ビューにコメントを追加した時、システムはbaseCommitishとtargetCommitishの両方の識別子と共にコメントを保存しなければならない
2. ユーザーが特定のベースコミットと対象コミットの差分を表示した時、システムはその正確な差分範囲に対して作成されたコメントのみを表示しなければならない
3. 差分A→Bに対して作成されたコメントがある場合、システムは差分C→Dを表示している時にそれを表示してはならない
4. コメントを保存する時、システムは完全な差分コンテキスト（baseCommitish、targetCommitish、ファイルパス、行番号）を含めなければならない

### 要件2

**ユーザーストーリー:** 開発者として、ファイルのViewedボタンの状態を永続化したい。これにより、同じ差分を再度開いた時に、以前のレビュー状態を保持できるようにしたい。

#### 受け入れ基準

1. ユーザーがViewedボタンをクリックしてファイルを既読としてマークした時、システムはその状態を差分コンテキストと共に保存しなければならない
2. Viewed状態を保存する時、システムはファイルの差分内容のハッシュ値も一緒に保存しなければならない
3. 同じ差分範囲を再表示した時、システムは保存されたハッシュ値と現在の差分内容を比較しなければならない
4. 差分内容が同じ場合、システムは以前のViewed状態を復元しなければならない
5. 差分内容が変更されている場合、システムはViewed状態をリセットして未読として表示しなければならない

### 要件3

**ユーザーストーリー:** 開発者として、コメントと既読データをlocalStorageで効率的に整理したい。これにより、多くの差分があってもパフォーマンスが良好に保たれるようにしたい。

#### 受け入れ基準

1. データを保存する時、システムはbaseCommitishとtargetCommitishを含む階層的なキー構造を使用しなければならない
2. データをクエリする時、システムは現在の差分範囲に関連するデータのみをロードしなければならない
3. localStorageが制限に近づいた場合、システムは古いデータをクリーンアップする方法を提供しなければならない
4. 古いデータ構造から移行する時、システムは可能な限り既存のコメントを保持しようと試みなければならない

### 要件4

**ユーザーストーリー:** 開発者として、コメントしている特定のコード範囲を見たい。これにより、行番号が変更されてもコメントが正確に保たれるようにしたい。

#### 受け入れ基準

1. コメントを保存する時、システムはチャンクヘッダー情報をキャプチャしなければならない
2. コメントを表示する時、システムは元のコードコンテキストを表示しなければならない
3. 行番号がシフトした場合、システムは依然として関連するコードの近くにコメントを表示しようと試みなければならない
4. コメントがコード範囲を参照する時、システムは差分からの旧行番号と新行番号の両方を保存しなければならない

