# 実装計画

- [ ] 1. CLIでdiffモード検知とwatch設定の実装
  - CLIオプションに`--watch`フラグを追加
  - 実行時の引数から現在のdiffモードを判定するロジック実装
  - diffモード情報をサーバーに渡すためのインターフェース作成
  - _要件: 2.1, 2.2_

- [ ] 2. @parcel/watcherによるFileWatcherServiceの実装
- [ ] 2.1 基本的なFileWatcherServiceクラスの作成

  - DiffMode enumの定義
  - FileWatcherServiceインターフェースの実装
  - @parcel/watcherのインストールと基本設定
  - _要件: 1.1, 1.2, 1.3, 1.4_

- [ ] 2.2 diffモード別監視設定の実装

  - ModeWatchConfigによる監視対象の設定マッピング
  - setupWatchers()メソッドでモード別の監視開始
  - 除外パターンの適切な設定（.git/objects、node_modules等）
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 2.3 デバウンス機能と変更検知の実装

  - 300msのデバウンス処理実装
  - ファイル変更、Git状態変更の区別
  - broadcastChange()による適切なイベント配信
  - _要件: 3.1, 3.3, 3.4, 3.5, 3.6_

- [ ] 3. SSE通信の拡張実装
- [ ] 3.1 既存のSSEエンドポイントの拡張

  - /api/watchエンドポイントの作成（既存の/api/heartbeatとは別）
  - WatchEventインターフェースの実装
  - diffMode、changeTypeを含むメッセージ形式の対応
  - _要件: 1.6, 3.1_

- [ ] 3.2 クライアント接続管理の実装

  - addClient/removeClientメソッドの実装
  - 複数クライアント対応のためのクライアント配列管理
  - 接続切断時のクリーンアップ処理
  - _要件: 5.2_

- [ ] 4. React側のReloadButtonコンポーネント実装
- [ ] 4.1 useFileWatchカスタムフックの作成

  - EventSourceによるSSE接続の管理
  - ClientWatchStateの状態管理
  - 自動再接続ロジックの実装
  - _要件: 5.2, 6.3_

- [ ] 4.2 ReloadButtonコンポーネントの実装

  - shouldReloadに基づくボタンの表示・非表示制御
  - GitHubライクなボタンデザインの実装
  - ローディング状態（isReloading）の表示
  - onReloadコールバックによる差分データ更新
  - _要件: 6.1, 6.2, 6.3_

- [ ] 5. App.tsxへのReloadButton統合
- [ ] 5.1 既存のApp.tsxでのReloadButton配置

  - 適切な位置へのReloadButtonコンポーネント配置
  - fetchDiffData関数とReloadボタンの連携
  - 既存のSSE接続（heartbeat）との共存
  - _要件: 1.6, 4.1, 4.2_

- [ ] 5.2 状態保持機能の実装

  - Reload時の既存レビューコメントの保持
  - スクロール位置の可能な限りの維持
  - ファイル削除時のコメント適切処理
  - _要件: 4.1, 4.2, 4.3_

- [ ] 6. サーバー起動時の統合処理
- [ ] 6.1 server.tsでのFileWatcherService統合

  - --watchフラグ有効時のFileWatcherService開始
  - diffモード情報の受け取りとFileWatcherServiceへの設定
  - 既存のサーバー機能との適切な統合
  - _要件: 2.1, 2.3_

- [ ] 6.2 エラーハンドリングの実装

  - ファイル監視失敗時のフォールバック処理
  - 権限不足エラーの適切な処理
  - Gitリポジトリ読み取りエラーの状態表示
  - _要件: 5.1, 5.3_

- [ ] 7. TypeScript型定義とインターフェース整備
- [ ] 7.1 共通型定義の作成

  - DiffMode、WatchEvent、ClientWatchState等の型定義ファイル作成
  - サーバー・クライアント間で共有する型の整理
  - 型安全性を保証するためのインターフェース定義
  - _要件: 全要件の型安全性確保_

- [ ] 8. テストの実装
- [ ] 8.1 FileWatcherServiceのユニットテスト

  - 各diffモードでの適切な監視設定のテスト
  - ファイル変更・Git状態変更検知のテスト
  - デバウンス機能のテスト
  - _要件: 1.1, 1.2, 1.3, 1.4, 3.1_

- [ ] 8.2 ReloadButtonコンポーネントのユニットテスト

  - 状態変更による表示切替のテスト
  - ボタンクリック時の適切な動作テスト
  - ローディング状態・エラー状態の表示テスト
  - _要件: 6.1, 6.2, 6.3_

- [ ] 8.3 統合テストの実装

  - SSE接続確立から変更通知配信までのテスト
  - 各diffモードでの適切な監視動作の確認
  - エラーハンドリングとフォールバック動作のテスト
  - _要件: 全要件の統合確認_

- [ ] 9. 最終的な統合と動作確認
- [ ] 9.1 各diffモードでの動作確認

  - デフォルトモード：新コミット後のReloadボタン表示確認
  - workingモード：ファイル変更・ステージング変更後の動作確認
  - stagedモード：ステージング変更後の動作確認
  - dotモード：ファイル変更・新コミット後の動作確認
  - 特定コミット：監視無効の確認
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 9.2 エラーケースと境界条件の確認

  - ネットワーク切断・再接続の動作確認
  - 大量ファイル変更時のパフォーマンス確認
  - Git操作（commit、add、reset）との適切な連携確認
  - _要件: 3.1, 3.3, 3.4, 3.5, 5.1, 5.2, 5.3_