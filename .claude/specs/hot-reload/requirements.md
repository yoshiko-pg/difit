# 要件ドキュメント

## 概要

difitでリポジトリの変更を監視し、表示中のdiffモードに応じた変更があった際に、GitHubのレビュー画面と同様にReloadボタンを表示する機能を実装します。これにより、ユーザーは変更があったことを把握でき、必要に応じて手動でdiffビューを更新できるようになります。

### 監視対象の判定ロジック

difitの表示モードに応じて監視対象を動的に決定：
- **デフォルト（引数なし）**: HEADコミット監視 → 新コミット作成でReloadボタン表示
- **特定コミット（`difit abc123`）**: コミット自体は不変のためファイル変更は監視しない
- **作業ディレクトリ（`difit working`）**: 作業ディレクトリのファイル変更 + ステージング状態の変更を監視
- **ステージング（`difit staged`）**: ステージング状態の変更を監視
- **全変更（`difit .`）**: 作業ディレクトリのファイル変更 + 新コミット作成を監視

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、表示中のdiffモードに関連する変更が発生した際に、現在の表示が最新でないことを知らせるReloadボタンが表示されることを望みます。これにより、変更があったことを把握し、必要に応じて更新できます。

#### 受入基準

1. WHEN difitがデフォルトモード（引数なし）で実行されており新しいコミットが作成された THEN システム SHALL Reloadボタンを表示する
2. WHEN difitが`working`モードで実行されており作業ディレクトリのファイルが変更されたまたはステージング状態が変更された THEN システム SHALL Reloadボタンを表示する
3. WHEN difitが`staged`モードで実行されておりステージング状態が変更された THEN システム SHALL Reloadボタンを表示する
4. WHEN difitが`.`モードで実行されており作業ディレクトリのファイルが変更されたまたは新コミットが作成された THEN システム SHALL Reloadボタンを表示する
5. WHEN difitが特定のコミットを表示中 THEN システム SHALL ファイル変更を監視しない（コミットは不変のため）
6. WHEN Reloadボタンがクリックされた THEN システム SHALL 新しいdiffデータを取得して表示を更新する

### 要件2

**ユーザーストーリー:** 開発者として、ファイル監視機能のオン/オフを制御したいです。これにより、必要に応じて変更監視を無効にできます。

#### 受入基準

1. WHEN ユーザーがCLIで`--watch`フラグを指定した THEN システム SHALL ファイル監視を有効にする
2. WHEN `--watch`フラグが指定されていない THEN システム SHALL 従来通り静的な表示を行う
3. IF ファイル監視が有効 THEN UI SHALL 監視状態をユーザーに表示する

### 要件3

**ユーザーストーリー:** 開発者として、頻繁な変更による不要な通知を避けたいです。これにより、システムリソースを効率的に使用できます。

#### 受入基準

1. WHEN 短時間内に複数のファイル変更が発生した THEN システム SHALL 変更をデバウンスして単一のReload表示として処理する
2. WHEN 関係のないファイル（.git/オブジェクト、node_modules/等）が変更された THEN システム SHALL 通知を無視する
3. WHEN デフォルトモードでGit操作（commit、merge等）により.git/HEADが更新された THEN システム SHALL Reloadボタンを表示する
4. WHEN ステージングモードでgit add/reset操作により.git/indexが更新された THEN システム SHALL Reloadボタンを表示する
5. WHEN workingモードでgit add/reset操作により.git/indexが更新された THEN システム SHALL Reloadボタンを表示する（ステージング基準点が変わるため）
6. WHEN `.`モードで新コミットが作成された THEN システム SHALL Reloadボタンを表示する（未コミット変更の基準点が変わるため）

### 要件4

**ユーザーストーリー:** 開発者として、Reloadボタンクリック後も既存のレビューコメントやUI状態が保持されることを望みます。これにより、作業中のレビューが中断されることなく、変更内容のみが更新されます。

#### 受入基準

1. WHEN Reloadボタンによってdiffビューが更新された THEN システム SHALL 既存のレビューコメントを保持する
2. WHEN ファイルが更新された THEN システム SHALL スクロール位置やUI状態を可能な限り維持する
3. IF ファイルが削除された THEN システム SHALL 該当ファイルのコメントを適切に処理する

### 要件5

**ユーザーストーリー:** 開発者として、ネットワーク接続やファイル監視のエラーに対してわかりやすいフィードバックを受けたいです。これにより、問題が発生した際に適切に対処できます。

#### 受入基準

1. WHEN ファイル監視に失敗した THEN システム SHALL エラーメッセージを表示してフォールバックする
2. WHEN サーバーとの接続が切断された THEN システム SHALL 再接続を試行する
3. WHEN Gitリポジトリの読み取りに失敗した THEN システム SHALL エラー状態を表示する

### 要件6

**ユーザーストーリー:** 開発者として、Reloadボタンの表示がGitHubライクで直感的であることを望みます。これにより、慣れ親しんだUIパターンで操作できます。

#### 受入基準

1. WHEN 変更が検知された THEN UI SHALL GitHubのレビュー画面と同様の視覚的なReloadボタンを表示する
2. WHEN Reloadボタンが表示された THEN UI SHALL 変更があったことを示すメッセージも表示する
3. WHEN Reloadが完了した THEN UI SHALL Reloadボタンを非表示にして通常状態に戻る